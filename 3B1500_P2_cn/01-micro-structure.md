结构概述
========

龙芯 GS464V 是一款实现了 64 位 MIPS64 指令集的通用 RISC 处理器核。在 MIPS64 R2
指令集的基础上，GS464V 还扩展了具有自主知识产权的访存、定点，浮点，多媒体，以及
向量指令。

![龙芯 GS464V 核基本结构\label{fig:gs464v-arch}](../images/architecture-gs464v.pdf)

图 \ref{fig:gs464v-arch} 显示了 GS464V 核的基本结构。 GS464V 的指令流水线每个时
钟周期取四条指令进行译码，并且动态发射到五个全流水的功能部件（两个定点，两个向量
，和一个访存部件）中。指令在保证依赖关系的前提下进行乱序执行，但指令的提交还是按
照程序原来的顺序以保证精确例外和访存顺序执行。四发射的超标量结构使得指令流水线中
指令和数据相关问题十分突出，GS464V 采用乱序执行技术和先进的存储系统设计来提高流
水线的效率。

GS464V 的乱序执行技术包括寄存器重命名、动态调度和转移预测技术。

- 寄存器重命名解决 WAR（读后写）和 WAW（写后写）相关，并用于例外和错误转移预测引
  起的精确现场恢复： GS464V 通过 64 项 的物理寄存器堆进行定点的重命名。
- 动态调度根据指令操作数准备好的次序而不是指令在程序中出现 的次序来执行指令，减
  少了 RAW（写后读）相关引起的阻塞。GS464V 有一个 16 项的定点保留站和一 个 16 项
  的浮点保留站用于乱序发射，并通过一个 64 项的 Reorder 队列（简称 ROQ）实现乱序
  执行的 指令按照程序的次序提交。
- 转移预测通过预测转移指令是否成功跳转来减少由于控制相关引起的阻 塞。GS464V 使用
  16 项的转移目标地址缓冲器（Branch Target Buffer，简称 BTB），2K 项的转移历史表
  （Branch History Table，简称 BHT），9 位的全局历史寄存器（Global History
  Register，简称 GHR），和 8 项的返回地址栈（Return Address Stack，简称 RAS）进
  行转移预测。

GS464V 先进的存储系统设计可以有效地提高流水线的效率。GS464V 的一级 Cache 由 64KB
的指 令 Cache（四路组相联）和 64KB 的数据 Cache（四路组相联）组成。GS464V 的 TLB
有 64 项，采用全相联结构，每项可以映射一个奇页和一个偶页，页大小在 4KB 到 16MB
之间可变。GS464V 通过 16 项 的访存队列以及 8 项的访存失效队列（Miss Queue）来动
态地解决地址依赖，实现访存操作的乱序执 行、非阻塞 Cache、取数指令猜测执行（Load
Speculation）等访存优化技术。GS464V 支持 128 位的 访存操作，其虚地址和物理地址均
为 48 位。

除了两个 64 位全流水的定点功能部件，GS464V 有两个向量功能部件（VPU）。每个向量部
件都可以全流水地执行 4 个 64 位的或者 8 个 32 位的 浮点/定点乘加操作。GS464V 定
义了大量 256 位向量指令来支持媒体应用、科学计算、信号处理和加 解密等应用。同时
GS464V 的向量部件包含了 GS464 浮点功能部件的功能，即同时实现了 MIPS64 的 64 位
浮点指令、32 位和 64 位的定点指令，以及 8 位和 16 位的用于媒体加速的 SIMD 指令。
为给 GS464V 的两个向量部件提供充足的数据， GS464V 采用了 128 项 256 位的向量寄存
器堆，并且采用的专门的 向量 DMA 模块在向量寄存器堆和二级 Cache 和内存之间数据传
输。

GS464V 支持 MIPS 公司的 EJTAG 调试规范，采用标准的 AXI 接口，其指令 Cache 实现了
奇偶校验，数据 Cache 实现了 ECC 校验。

流水线
------

GS464V 的基本流水线包括取指、预译码、译码、寄存器重命名、调度、发射、读寄存器、
执行、 提交等9级。每一级流水包括的基本操作如下：

1. **取指流水级：**用程序计数器 PC 的值去访问指令 Cache 和指令 TLB，如果指令 Cache
   和指令 TLB 都命中，则把四条新的指令取到指令寄存器 IR。
1. **预译码流水级：**对转移指令进行译码并预测跳转的方向。
1. **译码流水级：**把 IR 中的四条指令转换成 GS464V 的内部指令格式送往寄存器重命名
   模块。
1. **寄存器重命名流水级：**为逻辑目标寄存器分配一个新的物理寄存器，并将逻辑源寄存
   器映射到最近分配给它的物理寄存器。
1. **调度流水级：**将重命名的指令分配到定点或浮点保留站中等待执行，同时送到 ROQ 中
   用于执行后的顺序提交；此外，转移和访存指令还分别被送往转移和访存队列。
1. **发射流水级：**从定点或浮点保留站中为每个功能部件选出一条所有操作数都准备好的
   指令；在重命名时操作数没准备好的指令，通过侦听结果总线和 forward 总线等待它的
   操作数准备好。
1. **读寄存器流水级：**为上一流水级发射的指令从物理寄存器堆中读取相应的源操作数送
   到相应的功能部件。
1. **执行流水级：**根据指令的类型执行指令并把计算结果写回寄存器堆；结果总线还送往
   保留站和寄存器重命名表，通知相应的寄存器值已经可以使用了。
1. **提交流水级：**按照 Reorder 队列记录的程序的顺序提交已经执行完的指令，GS464V
   最多每拍可以提交四条指令，提交的指令送往寄存器重命名表用于确认它的目的寄存器
   的重命名关系并释放原来分配给同一逻辑寄存器的物理寄存器，并送往访存队列允许那
   些提交的存数指令写入 Cache 或内存。

\noindent 上述是基本指令的流水级。一些较复杂的指令，如定点乘除法、浮点以及访存指
令，在执行阶段需要多拍。

处理器特点
----------

与其它 MIPS 处理器不同，GS464V 处理器核只支持一种地址模式和一种尾端模式。

- 一种地址模式：GS464V 处理器核只支持 64 位虚拟地址，并且硬件保证兼容 32 位地址
  模式；
- 一种尾端模式：GS464V 处理器核只工作在小尾端（little endian）模式。

结构参数
--------

和以前的 GS464 处理器核相比， GS464V 最主要的改进是实现了对 256 位向量指令的支持
。表\ \ref{tab:gs464v-parameters} 列出了主要的 GS464V 核参数。

Table: GS464V 核参数 \label{tab:gs464v-parameters}

| 参数                      | 规格特征            |
| ------------------------- | ------------------- |
| 取指/译码/发射/执行/提交  | 4/4/5/5/4           |
| 流水线深度                | 9                   |
| 一级指令缓存              | 四通路64KB，私有    |
| 一级数据缓存              | 四通路64KB，私有    |
| Victim 缓存               | 128K，私有          |
| 二级缓存                  | 4M，共享            |
| 三级缓存                  | 无                  |
| 多核硬件缓存一致性        | 支持                |
| 动态调度窗口大小          | 64                  |
| 转移历史表（BHT）         | 2048 项             |
| 转移目标缓冲（BTB）       | 16 项               |
| 返回地址栈（RAS）         | 4 项                |
| 访存队列                  | 24 项               |
| 访存失效队列              | 8 项                |
| 调试接口协议              | EJTAG               |
| 高速I/O                   | HT2.0               |
| 制造工艺                  | 32nm CMOS           |
